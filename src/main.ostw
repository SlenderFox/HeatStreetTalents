import "../settings.lobby";
import "debug.ostw";
import "subroutines.ostw";

globalvar Boolean is_victory_declared;
globalvar Boolean is_mutator_activation_disabled; // Useless
globalvar Boolean mut_reinforcements;
globalvar Boolean mut_expendable;
globalvar Number last_spawn_phase_end_t;
globalvar Number[] game_or_mutator_start_huds; // Holds TextIDs *2
globalvar Number[] mutators_list; // 0 to 19
globalvar Number[] gmut_list; // 0 to 3
globalvar Number mut_count;

void set_map_cg() "Subroutine (Set Map CG): Set Spawns, Nodes, Edges, Distance Matrix, Ability Buy Location"
{
	spawn_pos_list = [Vector(206.454, 0.001, 70.22), Vector(221.427, 8.692, 66.933), Vector(193.658, 0.998, 67.449), Vector(229.543, 1.999, 85.875), Vector(224.599, 5.001, 110.683), Vector(199.902, 8.843, 109.823), Vector(176.589, 6.999, 66.024), Vector(212.836, 9, 81.39), Vector(228.988, 12.998, 65.82), Vector(186.82, 0.999, 87.814)];
	spawn_nearest_node_idx_list = [0, 24, 2, 40, 42, 35, 10, 25, 21, 7];
	nodes = [Vector(206.137, 0.041, 81.572), Vector(197.753, 1.002, 81.213), Vector(189.242, 0.998, 66.794), Vector(188.545, 3, 51.941), Vector(193.895, 16.5, 51.891), Vector(196.476, 16.501, 68.781), Vector(186.703, 0.999, 80.98), Vector(187.579, 0.999, 92.388), Vector(174.916, 5.001, 92.33), Vector(174.294, 5, 80.881), Vector(173.301, 6.999, 66.065), Vector(173.262, 6.998, 57.01), Vector(183.04, 7.999, 56.064), Vector(183.491, 7.999, 63.766), Vector(191.037, 7.999, 64.119), Vector(199.061, 7.998, 49.104), Vector(201.742, 7.998, 60.913), Vector(209.518, 7.998, 60.774), Vector(208.498, 9, 44.68), Vector(218.343, 12, 45.13), Vector(216.613, 14.001, 61.938), Vector(229.231, 13.001, 61.763), Vector(229.677, 9.187, 73.895), Vector(220.985, 7.998, 81.14), Vector(221.33, 9.002, 61.664), Vector(206.1, 9, 81.084), Vector(206.313, 7.999, 70.046), Vector(183.802, 5.998, 74.325), Vector(186.933, 6, 80.94), Vector(185.025, 6.001, 87.18), Vector(194.265, 8.001, 96.067), Vector(205.974, 9.025, 95.64), Vector(216.192, 7.999, 95.441), Vector(180.423, 8.998, 104.206), Vector(205.974, 8.027, 103.778), Vector(206.172, 7.998, 110.406), Vector(193.533, 9, 110.488), Vector(219.054, 5.998, 103.97), Vector(219.07, 1.998, 90.657), Vector(235.431, 1.998, 90.539), Vector(229.409, 1.999, 90.044), Vector(237.966, 3.998, 104.629), Vector(226.962, 4.284, 112.037), Vector(219.008, 0.998, 81.327), Vector(177.92, 0.002, 51.147), Vector(196.386, 16.5, 51.909), Vector(196.295, 16.5, 46.848), Vector(208.835, 16.5, 47.146)];
	edges = [[1, 43], [0, 2, 6, 43], [1, 3], [2, 4, 44], [45], [14, 45], [1, 7], [6, 8], [7, 9], [8, 10, 27, 29], [9, 11], [10, 12], [3, 11, 13], [12, 14, 16, 27, 29], [1, 3, 13, 15, 16], [14, 16], [13, 14, 15, 17, 18, 24, 26], [16, 18, 24, 26], [16, 17, 19], [18, 20], [17, 19, 21], [20, 22], [21, 23, 40], [22, 24, 25, 38], [16, 17, 23], [6, 23, 26], [16, 17, 25], [9, 13, 28, 29], [1, 27, 29], [9, 13, 27, 28, 30], [29, 31, 33, 34, 36], [30, 32, 34], [31, 38], [9, 30, 34], [30, 31, 33, 35, 37], [34, 36], [30, 35], [34, 38, 41], [37, 39, 40, 43], [38, 40, 41], [38, 39], [37, 39, 42], [35, 41], [0, 1, 38], [3], [3, 5, 15, 16, 46], [45, 47], [17, 19, 46]];
	distance_matrix = ["012346234567877667789!9878767655654563233451456710123512345676655667898767656555654563233451345621012423456765544556787656567666", "76567434456223453210133456765443344567654545656787677545567312345432025665654332233456543434545676676656678531233232303454543212", "23345654343343456556554556733123212346012345656667789!98787454567656643445624567323457101234545656678987676343456556554556735678", "43456821012343454556787656523234544545566674678943445732101232343445676545412123433434566564567854434643210123454556787656523234", "54454567767545675432355432101234344567654543434565565667778534564321244543210123233456543432323454454556667423453232353432321012", "12234543232121234334344555633456212124234343210112234543232232345445443445622345323235345454321012234543232343456556554556733456", "32323534434321110112343212123234544544344563345643434634545432221012343212134345655654344564456743434645545432221101234323234345", "65565545567445675454575665654333221012343434545676676655467556785454574565654333212101232324545676676544356556785565684566765444", "32321012333565667656743324546789445568345676544433432101223565556545632213436789334457234565433322343210112454445434521223425678", "43434634545432221123432102234345654553233453456732345712345543332234432120145455654563233453567843434623445432221123443221034345", "65565434456445673233463321232123233456543430112343343445556345672123462332343234344567654541012343343434456245673233463321232123", "23345654343110123223234554534567434457443234323434456765454221012112123443445678445568554345434545567876565332101212222333436789", "33456845545654565667898767644321032332122342678954556843212343454556787656523212301222344344678944556854323443454556787656533211", "210121233233678955667965434554565667898767644322321012344344789!5455685543454345455678765653321232210345545567893345684543455456", "56678987676443223212301221226789223457345456656767789!9878755433432341011231567833456845656776787889!?!9898665445433421011226789", "33456845656776787889!?!9898665445434521102326789445679565456656767789!9878755433432231212013789!55678!665456656767789!9878755433", "43212232310489!?112346234567767667789!987876654454345212234045674321244567876554455678765656767898788656678403454321214554543221", "12234543232343456556554556742012543232566565433222323454343454567667665667853101544343456565433321212343232454567667654556754210"];
	elevator_nodes = [];
	if (gamemode == 0)
	{
		iv_dom_objective_all_pos_list = [Vector(206.094, 2, 77.597), Vector(232.886, 4, 93.877), Vector(230.416, 6, 107.918), Vector(193.307, 11, 113.551), Vector(180.089, 11, 101.823), Vector(205.915, 11.043, 93.96), Vector(168.798, 7, 81.112), Vector(173.483, 9, 57.292), Vector(189.454, 5, 56.301), Vector(196.295, 18.5, 68.985), Vector(206.485, 10, 51.593), Vector(206.259, 10.999, 81.079), Vector(218.594, 10, 85.339), Vector(224.043, 3, 78.247), Vector(182.628, 3, 83.08)];
	}
	else if (gamemode == 2)
	{
		iv_dom_objective_all_pos_list = [[Vector(201.832, 8, 52.598), Vector(218.7, 8, 82.857), 47, 23], [Vector(188.463, 3, 54.695), Vector(173.555, 6.997, 65.855), 14, 10], [Vector(192.951, 9, 112.137), Vector(168.563, 5, 81.053), 35, 9], [Vector(205.608, 0.039, 81.423), Vector(232.253, 2, 97.003), 28, 39], [Vector(206.304, 9, 81.776), Vector(185.063, 1, 82.814), 25, 7]];
	}
	player_spawn_pos = Vector(181.974, 9, 96.862);
	player_spawn_facing = Forward();
	ability_shop_pos = Vector(182.587, 8.998, 105.229);
	buy_menu_left_up_forward[2] = Forward();
	buy_menu_cam_pos = 900 * Up();
}

void mut_add_mutator() "MUT Subroutine: Add Mutator"
{
	temp_2 = -50 - CountOf(mutators_list);
	if (mut_count % 5 == 0 && wave_number > 0)
	{
		BigMessage(AllPlayers(Team.All), "Gamechanging Mutator added!");
		is_gmut_enabled = true;
		temp_1 = RandomValueInArray(gmut_list);
		ModifyVariable(gmut_list, Operation.RemoveFromArrayByValue, temp_1);
		if (temp_1 == 0)
		{
			gmut_storm_raging = true;
			CreateHudText(AllPlayers(Team.All), null, "Storm Raging: Some enemies are enraged, killing them spreads the rage", null, Location.Right, temp_2 - 0.5, null, Color.Orange, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartDamageModification(combatants, FilteredArray(AllPlayers(Team.Team2), ArrayElement().gmut_var), 140, DamageModificationRev.ReceiversAndDamagers);
		}
		else if (temp_1 == 1)
		{
			gmut_sympathy_gains = true;
			CreateHudText(AllPlayers(Team.All), null, "Sympathy Gains: Killing enemies heals other nearby enemies", null, Location.Right, temp_2 - 0.5, null, Color.Orange, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 2)
		{
			gmut_adaptive_shield = true;
			CreateHudText(AllPlayers(Team.All), null, "Adaptive Shield: Enemies below 50% HP gain shields for every nearby player", null, Location.Right, temp_2 - 0.5, null, Color.Orange, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 3)
		{
			gmut_fortified = true;
			CreateHudText(AllPlayers(Team.All), null, "Fortified: Enemies resist stuns, knockbacks, and gain extra armour", null, Location.Right, temp_2 - 0.5, null, Color.Orange, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 4)
		{
			gmut_salvation = true;
			CreateHudText(AllPlayers(Team.All), null, "Salvation: Enemies heal themselves a small amount when they die", null, Location.Right, temp_2 - 0.5, null, Color.Orange, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
	}
	else if (CountOf(mutators_list))
	{
		BigMessage(AllPlayers(Team.All), "New Mutator added!");
		temp_1 = RandomValueInArray(mutators_list);
		ModifyVariable(mutators_list, Operation.RemoveFromArrayByValue, temp_1);
		if (temp_1 == 0)
		{
			mut_amped = true;
			CreateHudText(AllPlayers(Team.All), null, "Stampede: Enemies move faster", null, Location.Right, temp_2, null, Color.Green, Color.Green, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 1)
		{
			mut_hardwired = true;
			CreateHudText(AllPlayers(Team.All), null, "Hardwired: Mechanical enemies gain shields and resist fear & electrocution", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 2)
		{
			mut_promotion = true;
			CreateHudText(AllPlayers(Team.All), null, "Promotion: Higher tier heroes spawn more frequently", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 3)
		{
			mut_advanced_medkit = true;
			CreateHudText(AllPlayers(Team.All), null, "Advanced Medkit: Medics can revive tier 4 enemies and have less cooldown", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 4)
		{
			CreateHudText(AllPlayers(Team.All), null, "Berserk: Enemies below 50% health deal 25% more damage", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartDamageModification(combatants, FilteredArray(AllPlayers(Team.Team2), NormalizedHealth(ArrayElement()) <= 0.5), 125, DamageModificationRev.ReceiversAndDamagers);
		}
		else if (temp_1 == 5)
		{
			CreateHudText(AllPlayers(Team.All), null, "Regeneration: Enemies slowly regenerate health", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartHealOverTime(AllPlayers(Team.Team2), null, 9999, 10);
		}
		else if (temp_1 == 6)
		{
			mut_yakuza = true;
			CreateHudText(AllPlayers(Team.All), null, "Yakuza: Shinobis, Bowmasters, and Yokais gain more health and spawn as tier 3 enemies", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 7)
		{
			mut_emp_rounds = true;
			CreateHudText(AllPlayers(Team.All), null, "EMP Rounds: Enemies deal double damage to barriers and objects", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartDamageModification(combatants, AllPlayers(Team.Team2), 50, DamageModificationRev.ReceiversAndDamagers);
		}
		else if (temp_1 == 8)
		{
			mut_heartburn = true;
			CreateHudText(AllPlayers(Team.All), null, "Heartburn: Healing in combat is reduced by 30%", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartHealingModification(FilteredArray(combatants, ArrayElement().last_damage_taken_t + (ArrayElement().perk_die_hard ? 0.5 : 1) * (mut_deep_wounds ? 5 : 2.5) > TotalTimeElapsed()), combatants, 70, HealingModificationRev.ReceiversDamagersAndDamagePercent);
		}
		else if (temp_1 == 9)
		{
			mut_deep_wounds = true;
			CreateHudText(AllPlayers(Team.All), null, "Deep Wounds: Health regeneration delay is doubled", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 10)
		{
			mut_gear_upgrade = true;
			CreateHudText(AllPlayers(Team.All), null, "Gear Upgrade: All Troopers are replaced with Heavy Troopers", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 11)
		{
			CreateHudText(AllPlayers(Team.All), null, "Last Men Standing: The final enemies take 25% less damage", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			StartDamageModification(AllPlayers(Team.Team2), combatants, objective_phase_number == 3 ? 75 : 100, DamageModificationRev.ReceiversDamagersAndDamagePercent);
		}
		else if (temp_1 == 12)
		{
			mut_reinforcements = true;
			CreateHudText(AllPlayers(Team.All), null, "Reinforcements: Enemy spawn rate is increased", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 13)
		{
			mut_mutation = TotalTimeElapsed();
			CreateHudText(AllPlayers(Team.All), null, "Mutation: Some enemies spawn with increased strength and size", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 14)
		{
			mut_expendable = true;
			CreateHudText(AllPlayers(Team.All), null, "Expendable: Dead Troopers are replaced almost instantly", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 15)
		{
			mut_counterstrike = true;
			CreateHudText(AllPlayers(Team.All), null, "Counterstrike: Enemies can retreat from ultimates and counter back with their own", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 16)
		{
			mut_swan_song = true;
			CreateHudText(AllPlayers(Team.All), null, "Swan Song: Boss enemies continue fighting for 5 seconds before going down", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 17)
		{
			mut_bulletproof = true;
			CreateHudText(AllPlayers(Team.All), null, "Bulletproof: Tier 2 enemies gain an additional layer of overhealth", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 18)
		{
			mut_fully_loaded = true;
			CreateHudText(AllPlayers(Team.All), null, "Lock N' Load: Enemies can use additional abilities and have a higher clip size", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
		else if (temp_1 == 19)
		{
			mut_low_blow = true;
			CreateHudText(AllPlayers(Team.All), null, "Low Blow: Enemy knockback attacks double in damage and knockback", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
			SetKnockbackDealt(AllPlayers(Team.Team2), 200);
		}
		else if (temp_1 == 20)
		{
			mut_artful_dodger = true;
			CreateHudText(AllPlayers(Team.All), null, "Artful Dodger: Enemies can dodge attacks more often and easily", null, Location.Right, temp_2, null, Color.Green, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
		}
	}
}

void declare_victory() "Subroutine: Declare Victory"
{
	Wait(2, WaitBehavior.IgnoreCondition);
	AbortIf(is_victory_declared);
	is_victory_declared = true;
	DeclareTeamVictory(Team.Team1);
}

rule: "Mod by LemonAid#11644, Original mode by Shingen#21859"
{
	DisableInspectorRecording();
}

rule: "Global (Init): Set Workshop Vars, Game Vars, Disable Game Components, Create Game Entities"
{
	# Select and initialize Gamemode
	gamemode = [];
	if (WorkshopSettingToggle("Enabled Game Modes", "Invasion", true, 0))
	{
		ModifyVariable(gamemode, Operation.AppendToArray, 0);
	}
	if (WorkshopSettingToggle("Enabled Game Modes", "High Value Target", true, 1))
	{
		ModifyVariable(gamemode, Operation.AppendToArray, 1);
	}
	# Workaround: Need to reduce Slots because of spectator bug
	if (WorkshopSettingToggle("Enabled Game Modes", "Domination", true, 2) && NumberOfSlots(Team.Team1) <= 7)
	{
		ModifyVariable(gamemode, Operation.AppendToArray, 2);
	}
	if (CountOf(gamemode))
	{
		gamemode = RandomValueInArray(gamemode);
	}
	else
	{
		# Workaround: Need to reduce Slots because of spectator bug
		gamemode = RandomInteger(0, NumberOfSlots(Team.Team1) <= 7 ? 2 : 1);
	}
	if (gamemode == 2)
	{
		boss_list_1 = [Hero.Baptiste, Hero.Cassidy, Hero.Baptiste, Hero.Echo, Hero.Zarya, Hero.Lucio, Hero.Widowmaker, Hero.Ana, Hero.Orisa, Hero.Sigma, Hero.Tracer, Hero.Ana, Hero.Orisa, Hero.Hanzo, Hero.Genji, Hero.Brigitte, Hero.Widowmaker, Hero.Reaper, Hero.Kiriko, Hero.Dva, Hero.Pharah, Hero.Reinhardt];
		boss_list_2 = [Hero.Brigitte, Hero.Sombra, Hero.Reaper, Hero.Pharah, Hero.Kiriko, Hero.Tracer, Hero.Roadhog, Hero.Zarya, Hero.Lucio, Hero.Dva, Hero.Kiriko, Hero.Roadhog, Hero.Dva, Hero.Genji, Hero.Reinhardt, Hero.Mei, Hero.Cassidy, Hero.Sombra, Hero.Sigma, Hero.Echo, Hero.Brigitte, Hero.Mei];
	}
	else
	{
		boss_list_1 = [Hero.Cassidy, Hero.Baptiste, Hero.Lucio, Hero.Pharah, Hero.Widowmaker, Hero.Sombra, Hero.Reaper, Hero.Ana, Hero.Echo, Hero.Mei, Hero.Zarya, Hero.Tracer, Hero.Orisa, Hero.Kiriko, Hero.Reinhardt, Hero.Brigitte, Hero.Hanzo, Hero.Genji, Hero.Dva, Hero.Roadhog, Hero.Sigma, Hero.Reinhardt];
	}
	# 0=Easy, 1=Normal, 2=Hard, 3=Apocalypse
	temp_1 = WorkshopSettingCombo("Settings", "Difficulty", 1, ["Easy", "Normal", "Hard", "Apocalyptic"], 0);
	# 100-500%
	money_mult = WorkshopSettingInteger("Settings", "Money Generation Scalar (in Percent)", 100, 50, 500, 1);
	# 0=15w, 1=22w
	isGameLengthLong = WorkshopSettingCombo("Settings", "Game Length", 0, ["15 Waves", "22 Waves"], 2);
	CreateHudText(AllPlayers(), null, null, <"<0> Difficulty<1>", ["Easy", "Normal", "Hard", "Apocalyptic"][temp_1], money_mult == 100 ? "" : <", +<0>% money", money_mult - 100>>, Location.Right, -100, null, null, Color.Orange, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	money_mult /= 100;
	if (temp_1 == 0)
	{
		diff_health_mult = 0.6;
		diff_damage_mult = 0.6;
	}
	else if (temp_1 == 1)
	{
		diff_health_mult = 0.8;
		diff_damage_mult = 0.8;
	}
	else if (temp_1 == 2)
	{
		is_hard_mode_enabled = true;
		diff_health_mult = 1.15;
		diff_damage_mult = 1.15;
		mut_count = 5;
	}
	else
	{
		is_apocalyptic = true;
		money_mult *= 1.4;
		diff_health_mult = 1.5;
		diff_damage_mult = 1.25;
		mut_count = 5;
	}
	# 0=On, 1=Off
	is_mutator_activation_disabled = false;
	if (!is_mutator_activation_disabled)
	{
		is_mutator_mode_enabled = true;
		money_mult *= 2;
	}
	DisableCompletion();
	DisableScoring();
	DisableAnnouncer();
	progress_bar_strings = ["□□□□□", "▣□□□□", "■□□□□", "■▣□□□", "■■□□□", "■■▣□□", "■■■□□", "■■■▣□", "■■■■□", "■■■■▣", "■■■■■"];
	char_string = "0123456789!?#$%";
	aim_offset = 0.5 * Down();
	mutators_list[20] = null;
	mutators_list = MappedArray(mutators_list, CurrentArrayIndex());
	gmut_list[4] = null;
	gmut_list = MappedArray(gmut_list, CurrentArrayIndex());
	if (is_hard_mode_enabled || is_apocalyptic)
	{
		for (gIterator = -1; 3; 1)
		{
			MinWait();
			mut_add_mutator();
		}
	}
	# Initialize Map Specific Variables
	if (CurrentMap() == Map.Chateau_Guillard || CurrentMap() == Map.Chateau_Guillard_Halloween)
	{
		set_map_cg();
		is_map_cg = true;
	}
	else
	{
		CreateHudText(AllPlayers(), "\n\n\n\n\n\n\n\n\n\n\n\n\n\n     This Map is not supported! Restart and choose a valid map.     \n\n\n\n\n\n\n\n\n\n\n\n\n\n", null, null, Location.Top, -1000, Color.Yellow, null, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	}
	nodes_count = CountOf(nodes);
	buy_menu_left_up_forward[1] = DirectionFromAngles(HorizontalAngleFromDirection(buy_menu_left_up_forward[2]), VerticalAngleFromDirection(buy_menu_left_up_forward[2]) - 90);
	buy_menu_left_up_forward[0] = CrossProduct(buy_menu_left_up_forward[1], buy_menu_left_up_forward[2]);
	buy_menu_base_pos = buy_menu_cam_pos - (9 * buy_menu_left_up_forward[1]) + (142 * buy_menu_left_up_forward[2]);
	# Workaround: Need to reduce Slots because of spectator bug
	if (NumberOfSlots(Team.Team1) > 8)
	{
		CreateHudText(AllPlayers(), "\n\n\n\n\n\n\n\n\n\n\n\n\n\n     Too many player slots! Set Max Team 1 Players to 5 or lower and restart.     \n\n\n\n\n\n\n\n\n\n\n\n\n\n", null, null, Location.Top, -1000, Color.Yellow, null, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	}
	# Create HUDs
	CreateHudText(AllPlayers(), null, null, <"Heat Street: Talents - 3.4.6 | KFVAY - Chateau Guillard)​ ​-​ ​<0><1>", ["Invasion", "High Value Target", "Domination"][gamemode], MatchTime() ? <"<0><1><2>", MatchTime() > 10 ? "0:" : "", RoundToInteger(RoundToInteger(10 * MatchTime(), Rounding.Up) / 10, Rounding.Down), MatchTime() > 10 ? "" : <".<0>", RoundToInteger(10 * MatchTime(), Rounding.Up) % 10>> : "">, Location.Top, -100, null, null, Color.White, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	if (isGameLengthLong == false)
	{
		CreateHudText(AllPlayers(), <"Wave <0>/15 ", wave_number>, null, null, Location.Top, -99, Color.White, null, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	}
	else if (isGameLengthLong == true)
	{
		CreateHudText(AllPlayers(), <"Wave <0>/22 ", wave_number>, null, null, Location.Top, -99, Color.White, null, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	}
	if (gamemode == 2)
	{
		CreateHudText(AllPlayers(), null, objective_phase_number == 1 ? "" : "\n\n\n", null, Location.Top, -98, null, Color.White, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	}
	else
	{
		CreateHudText(AllPlayers(), null, objective_phase_number == 1 || objective_phase_number == 2 ? "" : "\n\n\n", null, Location.Top, -98, null, Color.White, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	}
	CreateHudText(FilteredArray(combatants, DistanceBetween(ArrayElement(), ability_shop_pos) > 2), <"\n<0>\n\n Press <1> to Start \n", ["   Invasion", "High Value Target", "    Domination"][gamemode], InputBindingString(Button.Interact)>, null, null, Location.Top, -92, Color.White, null, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	game_or_mutator_start_huds[0] = LastTextID();
	CreateHudText(FilteredArray(combatants, DistanceBetween(ArrayElement(), ability_shop_pos) > 2), null, null, "Change the Objective in the Workshop Settings", Location.Top, -91, null, null, Color.Green, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	game_or_mutator_start_huds[1] = LastTextID();
	CreateHudText(FilteredArray(combatants, !ArrayElement().downed_start_t && (ArrayElement().is_changing_heroes || objective_phase_number == 0 && !ArrayElement().in_buy_menu_start_t)), <"\n\n\n    You can change Heroes now\n\n Hold <0> to open the Hero menu \n", InputBindingString(Button.Reload)>, null, null, Location.Top, -90, Color.Yellow, null, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	CreateHudText(FilteredArray(combatants, ArrayElement().downed_start_t), null, null, <"Waiting for revival. Press <0> to spectate the next player.", InputBindingString(Button.Jump)>, Location.Top, -70, null, null, Color.Yellow, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	CreateHudText(LocalPlayer(), null, null, LocalPlayer().Tut_Active ? "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n" : <"Press [<0>] + [<1>] to toggle hud", InputBindingString(Button.Crouch), InputBindingString(Button.Reload)>, Location.Left, 9, null, null, Color.Orange, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	CreateProgressBarHudText(LocalPlayer().downed_start_t ? LocalPlayer().revive_timer : IsTrueForAny(combatants, ArrayContains(ArrayElement().revivers, LocalPlayer())) ? LocalPlayer() : [], LocalPlayer().downed_start_t ? LocalPlayer().revive_timer : LastOf(SortedArray(FilteredArray(combatants, ArrayContains(ArrayElement().revivers, LocalPlayer())), ArrayElement().revive_timer)).revive_timer, LocalPlayer().downed_start_t ? "You are being revived" : <"Reviving <0>", CountOf(FilteredArray(combatants, ArrayContains(ArrayElement().revivers, LocalPlayer()))) > 1 ? <"<0> Teammates", CountOf(FilteredArray(combatants, ArrayContains(ArrayElement().revivers, LocalPlayer())))> : FilteredArray(combatants, ArrayContains(ArrayElement().revivers, LocalPlayer()))[0]>, Location.Top, -60, LocalPlayer().downed_start_t ? LocalPlayer().is_revive_slow : IsTrueForAll(combatants, !ArrayContains(ArrayElement().revivers, LocalPlayer()) || ArrayElement().is_revive_slow) ? Color.Orange : Color.SkyBlue, Color.White, ProgressBarHudEvaluation.VisibleToValuesAndColor, Spectators.DefaultVisibility);
	CreateHudText(is_infrasight_on ? AllPlayers() : [], <"<0> Enemies have improved aim!", AbilityIconString(Hero.Widowmaker, Button.Ultimate)>, null, null, Location.Top, -50, Color.Violet, null, null, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	CreateHudText(IsTrueForAny(PlayersOnHero(Hero.Soldier76, Team.Team2), ArrayElement().ab_var_1 && ArrayElement().myTarget == LocalPlayer()) ? LocalPlayer() : [], <"<0> Locked on!", AbilityIconString(Hero.Soldier76, Button.Ultimate)>, null, null, Location.Top, -49, CustomColor(245 + 10 * SineFromRadians(4 * TotalTimeElapsed()), 205 + 50 * SineFromRadians(4 * TotalTimeElapsed()), 200 * SineFromRadians(4 * TotalTimeElapsed()), 255), null, null, HudTextRev.VisibleToAndColor, Spectators.DefaultVisibility);
	CreateHudText(AllPlayers(), null, null, "\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n", Location.Top, -1, null, null, Color.White, HudTextRev.VisibleTo, Spectators.DefaultVisibility);
	CreateHudText(AllPlayers(Team.Team2), <"Server Load: <0>, Average: <1>, Peak: <2>", ServerLoad(), ServerLoadAverage(), ServerLoadPeak()>, null, null, Location.Left, -110, is_waiting_to_remove_bot ? Color.Yellow : Color.White, null, null, HudTextRev.VisibleToStringAndColor, Spectators.DefaultVisibility);
	CreateHudText([], null, "Mod by Lemonaid:\nChateau Guillard: KFVAY\nKanezaka: H4H7K\nDorado: NNNS6\nEichenwalde: MH9DN\nHollywood: K3235\nMalevento: 8GRV8\\Rout", "____\nCredits to:\n Shingen\n SgtMoody\nDevelopful\n", Location.Left, -1000, Color.White, Color.LimeGreen, Color.Green, HudTextRev.VisibleTo, Spectators.VisibleAlways);
	# Create Sombra Stealth Timer IWT
	CreateProgressBarInWorldText(HeroOf(LocalPlayer()) == Hero.Sombra && LocalPlayer().is_invisible ? LocalPlayer() : [], LocalPlayer().sombra_stealth_timer, "Invisible", UpdateEveryFrame(EyePosition(LocalPlayer()) + 100 * DirectionFromAngles(HorizontalFacingAngleOf(LocalPlayer()), VerticalFacingAngleOf(LocalPlayer()) + 13.5)), 1.2, Clipping.DoNotClip, Color.Purple, Color.White, ProgressBarWorldEvaluation.VisibleToPositionAndValues, Spectators.DefaultVisibility);
	money_amount = 1400;
	set_random_perks();
	# Priority A: Players to Bots Damage Increase
	StartDamageModification(FilteredArray(AllPlayers(Team.Team2), ArrayElement().is_target_in_los && ArrayElement().myTarget.ab_priority == 1), combatants, 125, DamageModificationRev.ReceiversAndDamagers);
	# Priority A: Bots to Players Damage Decrease
	StartDamageModification(combatants, FilteredArray(AllPlayers(Team.Team2), ArrayElement().is_target_in_los && ArrayElement().myTarget.ab_priority == 1), 75, DamageModificationRev.ReceiversAndDamagers);
	# Priority C: Players to Players Healing Increase
	StartHealingModification(FilteredArray(combatants, NormalizedHealth(ArrayElement()) <= 0.5 && ArrayElement().last_damage_taken_t + 2.5 > TotalTimeElapsed()), FilteredArray(combatants, ArrayElement().ab_priority == 3), 140, HealingModificationRev.ReceiversDamagersAndDamagePercent);
	# Nemesis: Your Nemesis IWT
	CreateInWorldText(LocalPlayer().nemesis_killer ? LocalPlayer() : [], "Your Nemesis", LocalPlayer().nemesis_killer, 1.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndPosition, Color.Team2, Spectators.DefaultVisibility);
	CreateEffect(AllPlayers(), Effect.Ring, Color.SkyBlue, ability_shop_pos, 2, EffectRev.VisibleTo);
	CreateInWorldText(AllPlayers(), "Ability Shop", ability_shop_pos, 1.5, Clipping.DoNotClip, InworldTextRev.VisibleTo, Color.SkyBlue, Spectators.DefaultVisibility);
	CreateHudText(!LocalPlayer().is_combatant || LocalPlayer().downed_start_t || LocalPlayer().in_buy_menu_start_t || LocalPlayer().is_changing_heroes ? [] : LocalPlayer(), DistanceBetween(LocalPlayer(), ability_shop_pos) <= 2 ? MatchTime() ? <"Press <0> to buy Abilities", InputBindingString(Button.Interact)> : <"\n Press <0> to buy Abilities \n", InputBindingString(Button.Interact)> : LocalPlayer().can_use_drop_in_buy_menu || MatchTime() ? <"Hold <0> to buy Abilities", InputBindingString(Button.Interact)> : "", null, null, Location.Top, -80, Color.Green, null, null, HudTextRev.VisibleToAndString, Spectators.DefaultVisibility);
	# Create Buy Menu IWTs, on scale 2.5 1 space is 8.5 pixels
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), "┃\n┃\n┃\n┃\n┃\n┃\n┃\n┃\n┃", buy_menu_base_pos - 21 * buy_menu_left_up_forward[1] + 90 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleTo, Color.White, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), "┃\n┃\n┃\n┃\n┃\n┃\n┃\n┃\n┃", buy_menu_base_pos - 21 * buy_menu_left_up_forward[1] - 90 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleTo, Color.White, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), "Refund", buy_menu_base_pos + 45 * buy_menu_left_up_forward[1] + 90 * buy_menu_left_up_forward[0], 3, Clipping.DoNotClip, InworldTextRev.VisibleTo, Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), <"[<0>] <1>", InputBindingString(Button.Melee), LocalPlayer().is_showing_active_abilities ? "Show passive Abilities" : "Show active Abilities">, buy_menu_base_pos + 45 * buy_menu_left_up_forward[1], 3, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), <"[<0>] Leave", InputBindingString(Button.Interact)>, buy_menu_base_pos + 45 * buy_menu_left_up_forward[1] - 90 * buy_menu_left_up_forward[0], 3, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().ab_priority ? "Priority A\n  Swap" : "Priority A\n 1200$", buy_menu_base_pos + 20 * buy_menu_left_up_forward[1] + 112.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_priority ? Color.Yellow : CustomColor(0, 134, 171, 255), Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().ab_priority ? "Priority B\n  Swap" : "Priority B\n 1200$", buy_menu_base_pos - 2.5 * buy_menu_left_up_forward[1] + 112.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_priority ? Color.Yellow : CustomColor(0, 134, 171, 255), Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().ab_priority ? "Priority C\n  Swap" : "Priority C\n 1200$", buy_menu_base_pos - 25 * buy_menu_left_up_forward[1] + 112.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_priority ? Color.Yellow : CustomColor(0, 134, 171, 255), Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Stim Infusion\n    Swap" : "Stim Infusion\n   1200$" : LocalPlayer().ab_headhunter ? "Headhunter II\n  800$" : "Headhunter I\n  800$", buy_menu_base_pos + 20 * buy_menu_left_up_forward[1] + 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_headhunter < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Smoke Bomb\n    Swap" : "Smoke Bomb\n   1200$" : LocalPlayer().ab_antigens ? "Antigens II\n   600$" : "Antigens I\n   600$", buy_menu_base_pos - 2.5 * buy_menu_left_up_forward[1] + 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_antigens < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? "" : LocalPlayer().ab_quick_fix ? "Quick Fix II\n  700$" : "Quick Fix I\n  700$", buy_menu_base_pos - 25 * buy_menu_left_up_forward[1] + 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_quick_fix < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Cloak\n Swap" : "Cloak\n1200$" : LocalPlayer().ab_charged ? "Charged II\n  700$" : "Charged I\n  700$", buy_menu_base_pos + 20 * buy_menu_left_up_forward[1] + 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_charged < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Resurgence\n   Swap" : "Resurgence\n  1200$" : LocalPlayer().ab_haste ? "Haste II\n  800$" : "Haste I\n  800$", buy_menu_base_pos - 2.5 * buy_menu_left_up_forward[1] + 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_haste < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? "" : LocalPlayer().ab_heavy_impact ? "Heavy Impact II\n  1000$" : "Heavy Impact I\n  1000$", buy_menu_base_pos - 25 * buy_menu_left_up_forward[1] + 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_heavy_impact < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Feint\nSwap" : "Feint\n1200$" : LocalPlayer().ab_second_wind ? "Second Wind II\n   1000$" : "Second Wind I\n   1000$", buy_menu_base_pos + 20 * buy_menu_left_up_forward[1] - 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_second_wind < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Tear Gas\n Swap" : "Tear Gas\n   1200$" : LocalPlayer().ab_triage ? "Triage II\n  700$" : "Triage I\n  700$", buy_menu_base_pos - 2.5 * buy_menu_left_up_forward[1] - 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : LocalPlayer().ab_triage < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? "" : LocalPlayer().ab_resilience ? "Resilience II\n   800$" : "Resilience I\n   800$", buy_menu_base_pos - 25 * buy_menu_left_up_forward[1] - 22.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().ab_resilience < 2 ? Color.Green : Color.Gray, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Frenzy\n  Swap" : "Frenzy\n 1200$" : "+5% Health\n   500$", buy_menu_base_pos + 20 * buy_menu_left_up_forward[1] - 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? "Chain Hack\n   Swap" : "Chain Hack\n  1200$" : "+5% Damage\n  500$", buy_menu_base_pos - 2.5 * buy_menu_left_up_forward[1] - 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToStringAndColor, LocalPlayer().is_showing_active_abilities ? LocalPlayer().active_ab_number ? Color.Yellow : Color.Green : Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), LocalPlayer().is_showing_active_abilities ? "" : "+5% Healing\n  500$", buy_menu_base_pos - 25 * buy_menu_left_up_forward[1] - 67.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.Green, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), "Limited offer!", buy_menu_base_pos + 22.5 * buy_menu_left_up_forward[1] - 112.5 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.White, Spectators.DefaultVisibility);
	CreateInWorldText(LocalPlayer().in_buy_menu_start_t && LocalPlayer().is_showing_active_abilities ? LocalPlayer() : [], <"Hold or double tap <0> to use your active ability\n", InputBindingString(Button.Melee)>, buy_menu_base_pos - 25 * buy_menu_left_up_forward[1], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.White, Spectators.DefaultVisibility);
	CreateInWorldText(FilteredArray(combatants, ArrayElement().in_buy_menu_start_t), <"Press <0> to buy\n", InputBindingString(Button.PrimaryFire)>, buy_menu_base_pos - 74 * buy_menu_left_up_forward[1] - 55 * buy_menu_left_up_forward[0], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.White, Spectators.DefaultVisibility);
	# Create Ability Entities and Cursor
	CreateInWorldText(LocalPlayer().in_buy_menu_start_t ? LocalPlayer() : [], <"<0>$\n", RoundToInteger(money_mult * money_amount - LocalPlayer().money_spent_amount, Rounding.Down)>, buy_menu_base_pos - 74 * buy_menu_left_up_forward[1], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.White, Spectators.DefaultVisibility);
	CreateInWorldText(LocalPlayer().in_buy_menu_start_t ? LocalPlayer() : [], "▲", UpdateEveryFrame(buy_menu_base_pos - (4 + VerticalFacingAngleOf(LocalPlayer())) * buy_menu_left_up_forward[1] + HorizontalFacingAngleOf(LocalPlayer()) * buy_menu_left_up_forward[0]), 4, Clipping.DoNotClip, InworldTextRev.VisibleToPositionAndColor, CustomColor(245 + 10 * SineFromRadians(4 * TotalTimeElapsed()), 205 + 50 * SineFromRadians(4 * TotalTimeElapsed()), 200 * SineFromRadians(4 * TotalTimeElapsed()), 255), Spectators.DefaultVisibility);
	# Use Update Every Frame to avoid showing the String when the cursor is out of bounds, resulting in 0
	CreateInWorldText(UpdateEveryFrame(LocalPlayer().in_buy_menu_start_t && AbsoluteValue(HorizontalFacingAngleOf(LocalPlayer())) < 135 && AbsoluteValue(VerticalFacingAngleOf(LocalPlayer()) + 11.25) < 45 ? LocalPlayer() : []), UpdateEveryFrame(VerticalFacingAngleOf(LocalPlayer()) < -33.75 ? ["Leave Buy Menu\n", LocalPlayer().is_showing_active_abilities ? "Swap to the passive abilities page\n" : "Swap to the active abilities page\n", "Refund your money\n"][RoundToInteger((HorizontalFacingAngleOf(LocalPlayer()) + 135) / 90, Rounding.Down)] : [VerticalFacingAngleOf(LocalPlayer()) < -11.25 ? "The limited offer changes every wave\n" : ["Mystery Swap: Periodically swap to a random hero with a free ult\n         Health, damage and healing is increased by 20%", "Bulletstorm: Your weapon can hold unlimited ammo\n", "Die Hard: Your health regeneration delay is halved\n", <"Brass Knuckles: While using quick melee you are immune to Cloakers' charge attack\n<0>", "     Your quick melee attack knocks enemies down (15 second cooldown)">, "Vampiric: Heal for 30% of all dealt damage\n", "Crash N' Dash: Regenerate health while moving faster than 8 meters per second\n", "Golden Hour: You can be revived twice as fast\n", "Supercharge: Healing allies slowly charges their ultimate\n", "Nemesis: After going down automatically revive yourself when your killer dies\n", "Spec Ops: Gain 50 armour and immunity to grenadier smokes\n", "Sharpshooter: Deal 50% more damage to enemies that are further than 20 meters away\n", "Shockproof: Gain +15% speed and pass through enemies. \nBecome immune and deflect Taser electrocution attempts", <"<0>: <1>", LocalPlayer().talent_text[1], LocalPlayer().talent_text[2]>, <"<0>: <1>", LocalPlayer().talent_text[3], LocalPlayer().talent_text[4]>][current_perks[VerticalFacingAngleOf(LocalPlayer()) >= 11.25]], (LocalPlayer().is_showing_active_abilities ? ["Frenzy: Become invincible and force enemies to target you\n", <"          Chain Hack: Hack and electrocute an enemy\n<0>", "Can jump to nearby enemies up to 3 times with a shorter duration after each jump">, ""] : ["Increase your health by 5%\n", "Increase your damage by 5%\n", "Increase your healing by 5%\n"])[RoundToInteger((VerticalFacingAngleOf(LocalPlayer()) + 33.75) / 22.5, Rounding.Down)], (LocalPlayer().is_showing_active_abilities ? ["Feint: Dodge and dash into any direction, creating an explosion from start to finish", "Tear Gas: Launch a grenade that releases lingering noxious gas\n                 Enemies in the gas get stunned", ""] : [LocalPlayer().ab_second_wind ? "Second Wind II: Revive yourself when downed. Can only happen once every 60 seconds" : "Second Wind I: Revive yourself when downed. Can only happen once every 90 seconds", LocalPlayer().ab_triage ? "Triage II: Heal 50% more to players under 50% health\n" : "Triage I: Heal 25% more to players under 50% health\n", LocalPlayer().ab_resilience ? "Resilience II: Receive 20% less damage\nReceive 60% less knockback and inflict 60% more" : "Resilience I: Receive 20% less damage\nReceive 30% less knockback and inflict 30% more"])[RoundToInteger((VerticalFacingAngleOf(LocalPlayer()) + 33.75) / 22.5, Rounding.Down)], (LocalPlayer().is_showing_active_abilities ? ["Cloak: Become invisible and freeze nearby enemies when you become visible again\n", "   Resurgence: Heal yourself for 300 health per second\nIf you are at full health, heal a nearby injured ally instead", ""] : [LocalPlayer().ab_charged ? "Charged II: Ultimates cost 30% less\n" : "Charged I: Ultimates cost 15% less\n", LocalPlayer().ab_haste ? "Haste II: Ability cooldown is reduced by 50%\nDoes not affect abilities with multiple charges" : "Haste I: Ability cooldown is reduced by 25%\nDoes not affect abilities with multiple charges", LocalPlayer().ab_heavy_impact ? "Heavy Impact II: Every hit has a chance to stun the enemy for 2 seconds\n" : "Heavy Impact I: Every hit has a chance to stun the enemy for 1 second\n"])[RoundToInteger((VerticalFacingAngleOf(LocalPlayer()) + 33.75) / 22.5, Rounding.Down)], (LocalPlayer().is_showing_active_abilities ? ["Stim Infusion: Instantly start health regeneration\nGain +100% damage, +100% healing and +50% speed", "      Smoke Bomb: Create a smoke screen\nEnemies are less accurate when targeting allies in the smoke", ""] : [LocalPlayer().ab_headhunter ? "Headhunter II: Critical hits deal 60% more damage\n" : "Headhunter I: Critical hits deal 30% more damage\n", LocalPlayer().ab_antigens ? "Antigens II: Receive 40% more healing and a natural overtime heal" : "Antigens I: Receive 20% more healing and a natural overtime heal", LocalPlayer().ab_quick_fix ? "Quick Fix II: Eliminations restore 100 HP and shortly increase speed by 30%\n" : "Quick Fix I: Eliminations restore 50 HP and shortly increase speed by 15%\n"])[RoundToInteger((VerticalFacingAngleOf(LocalPlayer()) + 33.75) / 22.5, Rounding.Down)], ["    Priority A: Enemies are more likely to target you\nEnemies targeting you take 25% more and deal 25% less damage", <"         Priority B: Enemies are less likely to target you\n<0>", "Gain +20% damage and speed if you did not take damage in the last 3 seconds">, <"  Priority C: Enemies are much less likely to target you\n<0>", "Heal 40% more to allies in combat. Heal for 25% of dealt healing">][RoundToInteger((VerticalFacingAngleOf(LocalPlayer()) + 33.75) / 22.5, Rounding.Down)]][RoundToInteger((HorizontalFacingAngleOf(LocalPlayer()) + 135) / 45, Rounding.Down)]), buy_menu_base_pos - 55 * buy_menu_left_up_forward[1], 2.5, Clipping.DoNotClip, InworldTextRev.VisibleToAndString, Color.White, Spectators.DefaultVisibility);
	# Skip Assembling Heroes
	SetMatchTime(3);
	WaitUntil(IsGameInProgress(), 3.5);
	SetMatchTime(0);
	# Workaround: Need to reduce Slots because of spectator bug
	if (NumberOfSlots(Team.Team1) <= 8)
	{
		CreateDummyBot(Hero.Ana, Team.Team2, gamemode, 1000 * Down(), Forward());
		if (NumberOfSlots(Team.Team1) <= 8)
		{
			CreateDummyBot(Hero.Roadhog, Team.Team2, 3, 1000 * Down(), Forward());
		}
		if (NumberOfSlots(Team.Team1) <= 5)
		{
			CreateDummyBot(Hero.Cassidy, Team.Team2, 4, 1000 * Down(), Forward());
		}
		if (NumberOfSlots(Team.Team1) <= 6)
		{
			CreateDummyBot(Hero.Cassidy, Team.Team2, 5, 1000 * Down(), Forward());
		}
		CreateDummyBot(Hero.Soldier76, Team.Team2, 6, 1000 * Down(), Forward());
		CreateDummyBot(Hero.Soldier76, Team.Team2, 7, 1000 * Down(), Forward());
		CreateDummyBot(Hero.Soldier76, Team.Team2, 8, 1000 * Down(), Forward());
		CreateDummyBot(Hero.Soldier76, Team.Team2, 9, 1000 * Down(), Forward());
		CreateDummyBot(Hero.Soldier76, Team.Team2, 10, 1000 * Down(), Forward());
	}
	is_gmut_enabled = true;
	Wait(2, WaitBehavior.IgnoreCondition);
}

// After the other settings
rule: "Special thanks"
{
	Any Special_Thanks = WorkshopSettingCombo("Credits", "Thank you to", 0, ["LemonAid", "Shingen", "LtVictory", "SgtMoody", "Developful"], 0);
}

rule: "Global (First Wave): Create Mutator Start HUD, Scale Values, Set Level"
if (wave_number == 0)
if (IsTrueForAny(combatants, IsButtonHeld(ArrayElement(), Button.Interact) && DistanceBetween(ArrayElement(), ability_shop_pos) > 2))
{
	DestroyHudText(game_or_mutator_start_huds[0]);
	DestroyHudText(game_or_mutator_start_huds[1]);
	EnableMusic();
	wave_number = 1;
	SetUltimateCharge(combatants, 0);
	AllPlayers(Team.Team2).base_tier = 1;
	enable_normal_spawns = true;
	ModifyTeamScore(Team.Team1, 1);
	if (gamemode == 2)
	{
		enable_objective_enemy_spawn = 2;
		iv_dom_objective_pos = RandomValueInArray(iv_dom_objective_all_pos_list);
		objective_progress = [0, 0];
	}
	else
	{
		enable_objective_enemy_spawn = true;
		(<Player>PlayersInSlot(gamemode, Team.Team2)).base_tier = -1;
	}
}

rule: "Global (Next Wave): Revive Players, Scale Values, Set Level, Set Mutators"
if (objective_phase_number == 3)
if (NumberOfLivingPlayers(Team.Team2) == 0)
{
	if (wave_number >= 15 && isGameLengthLong == false)
	{
		async! declare_victory();
	}
	else if (wave_number >= 22 && isGameLengthLong == true)
	{
		async! declare_victory();
	}
	objective_phase_number = 0;
	(<Player>FilteredArray(combatants, ArrayElement().downed_start_t && ArrayElement().downed_start_t + 0.1 < TotalTimeElapsed())).downed_start_t = false;
	BigMessage(AllPlayers(), "Wave cleared!");
	money_amount += (wave_number >= 2 ? 30 : 45) + 25 * wave_number;
	set_random_perks();
	if (is_mutator_mode_enabled && wave_number % 2 == 1 || is_apocalyptic)
	{
		SkipIf(is_hard_mode_enabled || is_apocalyptic, 1);
		mut_count += 1;
		mut_add_mutator();
		SkipIf(!(is_hard_mode_enabled || is_apocalyptic), 1);
		mut_count += 1;
	}
	DisableMusic();
	SetMatchTime(20);
	Wait(0.5, WaitBehavior.IgnoreCondition);
	WaitUntil(!MatchTime(), 99999);
	EnableMusic();
	wave_number += 1;
	enable_normal_spawns = true;
	ModifyTeamScore(Team.Team1, 1);
	if (gamemode == 2)
	{
		enable_objective_enemy_spawn = 2;
		hvt_dom_objective_killed_count = false;
		iv_dom_objective_pos = RandomValueInArray(RemoveFromArray(iv_dom_objective_all_pos_list, iv_dom_objective_pos));
		objective_progress = [0, 0];
	}
	else
	{
		enable_objective_enemy_spawn = true;
	}
	if (wave_number == 2)
	{
		(<Player>PlayersInSlot(5, Team.Team2)).base_tier = 2;
		(<Player>PlayersInSlot(6, Team.Team2)).base_tier = 2;
	}
	else if (wave_number == 3)
	{
		(<Player>PlayersInSlot(8, Team.Team2)).base_tier = 2;
	}
	else if (wave_number == 4)
	{
		(<Player>PlayersInSlot(2, Team.Team2)).base_tier = 3;
		(<Player>PlayersInSlot(3, Team.Team2)).base_tier = 3;
	}
	else if (wave_number == 5)
	{
		(<Player>PlayersInSlot(7, Team.Team2)).base_tier = 2;
	}
	else if (wave_number == 8)
	{
		(<Player>PlayersInSlot(7, Team.Team2)).base_tier = 3;
	}
	else if (wave_number == 9)
	{
		(<Player>PlayersInSlot(4, Team.Team2)).base_tier = 3;
	}
	AbortIf(!mut_expendable);
	(<Player>FilteredArray(PlayersOnHero(Hero.Soldier76, Team.Team2), ArrayElement().base_tier <= 2)).is_expendable = true;
}

rule: "Global: Enable normal Spawns"
if (objective_phase_number == 1 || objective_phase_number == 2)
if (!enable_normal_spawns)
if (NumberOfLivingPlayers(Team.Team2) < NumberOfPlayers(Team.Team2))
{
	temp_1 = FilteredArray(AllLivingPlayers(Team.Team2), !ArrayElement().is_living_boss);
	temp_1 = 2 * CountOf(FilteredArray(temp_1, ArrayElement().real_tier <= 2)) + 5 * CountOf(FilteredArray(temp_1, ArrayElement().real_tier == 3)) + 10 * CountOf(FilteredArray(temp_1, ArrayElement().real_tier == 4));
	if (temp_1 <= Max(5, TotalTimeElapsed() - last_spawn_phase_end_t - 25 - 20 * CountOf(FilteredArray(combatants, ArrayElement().downed_start_t)) / combatants_count))
	{
		Wait((gamemode == 1 && objective_phase_number == 1 || gamemode == 2 && IsTrueForAny(AllLivingPlayers(Team.Team2), ArrayElement().is_living_boss) ? 11 : 6) - (mut_reinforcements ? 3 : 0), WaitBehavior.AbortWhenFalse);
		AbortIfConditionIsFalse();
		enable_normal_spawns = true;
		ModifyTeamScore(Team.Team1, 1);
	}
	else
	{
		Wait(1, WaitBehavior.AbortWhenFalse);
		LoopIfConditionIsTrue();
	}
}

rule: "Global: Disable normal Spawns"
if (objective_phase_number == 1 || objective_phase_number == 2)
if (enable_normal_spawns)
if (NumberOfLivingPlayers(Team.Team2) == NumberOfPlayers(Team.Team2))
{
	enable_normal_spawns = false;
	last_spawn_phase_end_t = TotalTimeElapsed();
}

rule: "Global: Defeat"
if (wave_number > 0)
if (IsTrueForAll(combatants, ArrayElement().downed_start_t))
{
	Wait(2, WaitBehavior.AbortWhenFalse);
	AbortIf(is_victory_declared);
	is_victory_declared = true;
	DeclareTeamVictory(Team.Team2);
}

rule: "Global: Anti-crash"
if (NumberOfPlayers(Team.Team2) > 7)
if (ServerLoadAverage() >= 255)
{
	is_load_limit_reached = true;
	if (!is_waiting_to_remove_bot && wave_number > 0)
	{
		WaitUntil(ServerLoadAverage() < 255, 4);
		if (ServerLoadAverage() >= 255)
		{
			is_waiting_to_remove_bot = true;
			WaitUntil(ServerLoadAverage() < 255, 99999);
		}
	}
	else
	{
		WaitUntil(ServerLoadAverage() < 255, 99999);
	}
	is_load_limit_reached = false;
}

rule: "All Teams: Player left Match, Scale Damage"
Event.OnPlayerLeave
{
	update_combatants();
	temp_2 = (mut_emp_rounds ? 2 : 1) * (20 + 8.25 * (wave_number - 1 + Max(0, wave_number - 9))) * (0.139 + 0.2 * combatants_count) * 9 / NumberOfPlayers(Team.Team2);
	for (gIterator = 0; NumberOfLivingPlayers(Team.Team2); 1)
	{
		SetDamageDealt(AllLivingPlayers(Team.Team2)[gIterator], AllLivingPlayers(Team.Team2)[gIterator].Damage_Dealt * temp_2);
	}
}

import "pathing.ostw";
import "bots.ostw";
import "team1.ostw";
import "perks.ostw";
import "mutators.ostw";
import "invasion.ostw";
import "highvaluetarget.ostw";
import "domination.ostw";
import "info.ostw";
import "talents.ostw";
